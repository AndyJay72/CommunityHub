<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calendar | VenuePro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>if (!localStorage.getItem('vp_token')) { window.location.href = 'login.html'; }</script>
    <style>
        :root{--bg-dark:#0f172a;--bg-card:rgba(30,41,59,0.7);--border:rgba(148,163,184,0.1);--primary:#6366f1;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--text-main:#f8fafc;--text-muted:#94a3b8;--sidebar-width:260px}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Plus Jakarta Sans',sans-serif}
        body{background-color:var(--bg-dark);background-image:radial-gradient(at 0% 0%,hsla(253,16%,7%,1) 0,transparent 50%),radial-gradient(at 50% 0%,hsla(225,39%,30%,1) 0,transparent 50%);color:var(--text-main);min-height:100vh;display:flex;overflow-x:hidden}
        aside{width:var(--sidebar-width);background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);border-right:1px solid var(--border);padding:2rem;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform 0.3s ease}
        .brand{font-size:1.5rem;font-weight:700;color:white;display:flex;align-items:center;justify-content:space-between;margin-bottom:3rem}
        .nav-link{display:flex;align-items:center;gap:12px;padding:12px 16px;color:var(--text-muted);text-decoration:none;border-radius:8px;margin-bottom:5px;transition:all 0.2s;font-weight:500}
        .nav-link:hover,.nav-link.active{background:rgba(99,102,241,0.1);color:var(--primary)}
        .close-sidebar{display:none;background:none;border:none;color:white;font-size:1.2rem;cursor:pointer}
        main{margin-left:var(--sidebar-width);flex:1;padding:2rem;max-width:1600px;width:100%;transition:margin-left 0.3s ease}
        .menu-toggle{display:none;background:var(--bg-card);border:1px solid var(--border);color:white;width:40px;height:40px;border-radius:8px;align-items:center;justify-content:center;cursor:pointer;margin-right:15px}
        .cal-filter-bar{display:flex;gap:10px;align-items:center;margin-bottom:1rem;flex-wrap:wrap}
        .cal-filter-select{background:rgba(0,0,0,0.35);border:1px solid var(--border);border-radius:10px;color:var(--text-main);padding:9px 14px;font-size:0.88rem;outline:none;cursor:pointer;min-width:160px;font-family:inherit}
        .cal-filter-select:focus{border-color:var(--primary)}
        .cal-filter-select option{background:#1e293b}
        .cal-legend{display:flex;gap:16px;align-items:center;margin-left:auto;flex-wrap:wrap}
        .legend-item{display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--text-muted)}
        .legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
        #calendar{background:var(--bg-card);padding:20px;border-radius:16px;border:1px solid var(--border);min-height:700px}
        .fc{color:var(--text-main)}
        .fc-toolbar-title{font-size:1.4rem !important;font-weight:700}
        .fc-button{background:#ec4899 !important;border:none !important;font-weight:600 !important;border-radius:8px !important}
        .fc-button:hover{background:#d6387f !important}
        .fc-button-active{background:#d6387f !important}
        .fc-day-today{background:rgba(99,102,241,0.08) !important}
        .fc-event{cursor:pointer;border:none !important;padding:3px 6px !important;font-size:0.82rem;border-radius:6px !important}
        .fc-col-header-cell{background:#1e293b;padding:10px 0;border:none !important}
        .fc-scrollgrid{border:1px solid var(--border) !important}
        .fc-theme-standard td,.fc-theme-standard th{border-color:rgba(148,163,184,0.08) !important}
        .fc-list{background:transparent !important}
        .fc-list-table td{background:transparent !important;border-color:var(--border) !important;color:var(--text-main) !important}
        .fc-list-event:hover td{background:rgba(99,102,241,0.07) !important}
        .fc-list-day-cushion{background:#182235 !important}
        .fc-list-day-text,.fc-list-day-side-text{color:var(--text-muted) !important}
        .fc-list-event-title a{color:var(--text-main) !important;text-decoration:none}
        .fc-list-event-time{color:var(--text-muted) !important}
        .fc-list-empty{background:var(--bg-card) !important;color:var(--text-muted) !important}
        .fc-bg-event{opacity:0.25 !important}
        /* ── Blocked Dates Modal ── */
        .bd-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:3000;display:none;justify-content:center;align-items:flex-start;padding-top:3rem;overflow-y:auto}
        .bd-modal-overlay.open{display:flex}
        .bd-modal-card{background:#1e293b;border:1px solid var(--border);width:92%;max-width:580px;border-radius:20px;padding:2rem;box-shadow:0 30px 60px rgba(0,0,0,0.5);animation:slideUp 0.25s ease;max-height:80vh;overflow-y:auto;margin-bottom:2rem}
        .bd-input,.bd-select{background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;color:var(--text-main);padding:9px 12px;font-size:0.88rem;font-family:inherit;width:100%;outline:none;min-height:unset}
        .bd-input:focus,.bd-select:focus{border-color:#ef4444}
        .bd-select option{background:#1e293b}
        .bd-btn-add{background:#ef4444;border:none;color:white;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;font-size:0.9rem;min-height:unset;width:100%}
        .bd-btn-add:hover{background:#dc2626}
        .bd-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;gap:1rem;margin-bottom:0.5rem}
        .bd-item-label{font-weight:600;color:white;font-size:0.9rem}
        .bd-item-detail{font-size:0.8rem;color:var(--text-muted);margin-top:2px}
        .bd-item-del{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444;width:32px;height:32px;min-height:unset;border-radius:6px;cursor:pointer;font-size:0.85rem;flex-shrink:0;display:flex;align-items:center;justify-content:center}
        .bd-item-del:hover{background:rgba(239,68,68,0.3)}
        .bd-empty{text-align:center;padding:1.5rem;color:var(--text-muted);font-size:0.88rem}
        body.light-mode .bd-modal-card{background:#ffffff;border-color:rgba(0,0,0,0.12);color:#0f172a}
        body.light-mode .bd-input,body.light-mode .bd-select{background:rgba(0,0,0,0.04);border-color:rgba(0,0,0,0.15);color:#0f172a}
        body.light-mode .bd-item{background:rgba(0,0,0,0.03);border-color:rgba(0,0,0,0.1)}
        body.light-mode .bd-item-label{color:#0f172a}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:2000;display:none;justify-content:center;align-items:center}
        .modal-overlay.open{display:flex}
        .modal-card{background:#1e293b;border:1px solid var(--border);width:92%;max-width:520px;border-radius:20px;padding:2rem;box-shadow:0 30px 60px rgba(0,0,0,0.5);animation:slideUp 0.25s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .modal-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem;border-bottom:1px solid var(--border);padding-bottom:1rem}
        .modal-title{font-size:1.15rem;font-weight:700;line-height:1.3;flex:1;padding-right:1rem}
        .modal-close-btn{background:none;border:none;color:var(--text-muted);font-size:1.4rem;cursor:pointer}
        .modal-close-btn:hover{color:white}
        .modal-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(148,163,184,0.06);font-size:0.9rem}
        .modal-label{color:var(--text-muted)}
        .modal-val{font-weight:600;color:white;text-align:right;max-width:60%;word-break:break-all}
        .status-pill{padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:700;text-transform:uppercase;display:inline-block}
        .pill-paid{background:rgba(16,185,129,0.15);color:var(--success);border:1px solid rgba(16,185,129,0.3)}
        .pill-balance{background:rgba(245,158,11,0.15);color:var(--warning);border:1px solid rgba(245,158,11,0.3)}
        .pill-past{background:rgba(148,163,184,0.1);color:var(--text-muted);border:1px solid rgba(148,163,184,0.2)}
        .pay-timeline{display:flex;align-items:flex-start;gap:4px;margin-top:1rem;padding:12px 14px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--border)}
        .tl-step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
        .tl-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700}
        .tl-dot.done{background:var(--success);color:#0f172a}
        .tl-dot.active{background:var(--warning);color:#0f172a}
        .tl-dot.pending{background:rgba(148,163,184,0.15);color:var(--text-muted);border:2px solid rgba(148,163,184,0.3)}
        .tl-label{font-size:0.68rem;color:var(--text-muted);text-align:center;white-space:nowrap}
        .tl-line{flex:1;height:2px;background:rgba(148,163,184,0.15);margin-top:13px;align-self:flex-start}
        .tl-line.done{background:var(--success)}
        .close-btn{width:100%;padding:11px;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:white;border-radius:8px;margin-top:1.25rem;cursor:pointer;font-family:inherit;font-size:0.9rem;font-weight:600}
        .close-btn:hover{background:rgba(255,255,255,0.1)}
        .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:90}
        .overlay.active{display:block}
        @media(max-width:768px){
            aside{transform:translateX(-100%)} aside.active{transform:translateX(0)}
            main{margin-left:0;padding:1rem} .menu-toggle{display:flex} .close-sidebar{display:block}
            .cal-legend{margin-left:0} .fc-toolbar{flex-direction:column;gap:10px}
        }

        /* ── LIGHT MODE OVERRIDES ── */
        body.light-mode { background-color: #eef2f7; background-image: none; color: #0f172a; }
        body.light-mode aside { background: rgba(255,255,255,0.97); border-right-color: rgba(0,0,0,0.1); }
        body.light-mode .nav-link { color: #475569; }
        body.light-mode .nav-link:hover, body.light-mode .nav-link.active { background: rgba(99,102,241,0.1); color: var(--primary); }
        body.light-mode .brand { color: #0f172a; }
        body.light-mode main { background: transparent; }
        body.light-mode .card,
        body.light-mode .table-container,
        body.light-mode .metric-card,
        body.light-mode .booking-card,
        body.light-mode .glance-card,
        body.light-mode .sum-card,
        body.light-mode .table-wrap,
        body.light-mode #calendar,
        body.light-mode .section-container { background: rgba(255,255,255,0.92); border-color: rgba(0,0,0,0.1); color: #0f172a; }
        body.light-mode th { background: rgba(240,244,248,0.9); color: #475569; border-color: rgba(0,0,0,0.07); }
        body.light-mode td { color: #0f172a; border-color: rgba(0,0,0,0.06); }
        body.light-mode .stat-value, body.light-mode .glance-val, body.light-mode .sum-val { color: #0f172a; }
        body.light-mode .stat-label, body.light-mode .glance-lbl, body.light-mode .sum-lbl,
        body.light-mode .b-meta, body.light-mode .db-month, body.light-mode .metric-info p { color: #64748b; }
        body.light-mode h1, body.light-mode h2, body.light-mode h3, body.light-mode h4 { color: #0f172a; }
        body.light-mode .menu-toggle,
        body.light-mode .search-bar,
        body.light-mode .sf-input, body.light-mode .sf-select,
        body.light-mode .f-input, body.light-mode .f-select,
        body.light-mode .cal-filter-select { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.15); color: #0f172a; }
        body.light-mode .search-bar input { color: #0f172a; }
        body.light-mode .filter-btn { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.12); color: #475569; }
        body.light-mode .filter-btn:hover, body.light-mode .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        body.light-mode .pay-modal-card, body.light-mode .modal-card,
        body.light-mode .receipt-card { background: #ffffff; border-color: rgba(0,0,0,0.12); color: #0f172a; }
        body.light-mode .detail-value { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.1); color: #0f172a; }
        body.light-mode .live-clock { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.12); color: #475569; }
        body.light-mode .pay-amount-input { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.15); color: #0f172a; }
        body.light-mode .pay-booking-info { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
        body.light-mode .date-badge { background: rgba(0,0,0,0.05); }
        body.light-mode .bh-stat { background: rgba(0,0,0,0.04); }
        body.light-mode .log-tbody tr:hover, body.light-mode tbody tr:hover { background: rgba(0,0,0,0.03) !important; }
        .theme-toggle { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; transition: 0.2s; flex-shrink: 0; }
        .theme-toggle:hover { color: white; border-color: white; }
        body.light-mode .theme-toggle { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.15); color: #475569; }
        body.light-mode .theme-toggle:hover { color: #0f172a; border-color: #94a3b8; }
    
        /* ============================================================
           RESPONSIVE DESIGN — VenuePro Full Coverage
           Breakpoints: 1200 / 1024 / 900 / 768 / 480 / 360
        ============================================================ */

        /* Sidebar overlay backdrop (mobile) */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 199;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { display: block; }

        /* Touch-friendly minimum tap targets */
        button, .btn, a.btn, select, input[type="text"],
        input[type="email"], input[type="password"], input[type="tel"],
        input[type="number"], input[type="date"], input[type="time"],
        textarea { min-height: 44px; }

        /* Responsive table wrapper */
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            border-radius: 12px;
        }
        .table-wrap table { min-width: 600px; }

        /* ---- 1200px (large desktop to medium desktop) ---- */
        @media (max-width: 1200px) {
            .stats-grid, .metrics-grid, .kpi-grid, .summary-strip {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }

        /* ---- 1024px (small laptop / large tablet landscape) ---- */
        @media (max-width: 1024px) {
            aside { width: 220px; }
            main { margin-left: 220px; }
            .stats-grid, .metrics-grid, .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* ---- 900px (tablet landscape) ---- */
        @media (max-width: 900px) {
            .stats-grid, .metrics-grid, .kpi-grid, .summary-strip {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-split, .form-grid-2col { grid-template-columns: 1fr; }
            .filter-bar, .top-bar, .action-bar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .filter-bar input, .filter-bar select,
            .top-bar input, .top-bar select { width: 100%; }
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* ---- 768px (tablet portrait / all mobiles) ---- */
        @media (max-width: 768px) {
            aside {
                position: fixed;
                left: 0; top: 0;
                height: 100vh;
                width: 260px;
                transform: translateX(-100%);
                z-index: 200;
                transition: transform 0.3s ease;
            }
            aside.active { transform: translateX(0); }
            .close-sidebar { display: block !important; }
            .menu-toggle { display: flex !important; }
            main { margin-left: 0 !important; padding: 1rem; }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .page-header h1 { font-size: 1.4rem; }
            .page-header .header-actions { width: 100%; }
            .page-header .header-actions button,
            .page-header .header-actions a { width: 100%; justify-content: center; }

            .stats-grid, .metrics-grid, .kpi-grid, .summary-strip {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .filter-bar, .top-bar, .action-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .filter-bar input, .filter-bar select,
            .top-bar input, .top-bar select,
            .action-bar input, .action-bar select { width: 100%; }

            .filter-tabs { flex-wrap: wrap; gap: 0.4rem; }
            .filter-tabs button { flex: 1 1 auto; min-width: 80px; font-size: 0.8rem; }

            .modal-content, .modal-box, .modal > div:first-child {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 88vh !important;
                overflow-y: auto;
                border-radius: 12px !important;
                margin: 1rem auto;
            }
            .modal-grid, .form-row, .form-grid {
                grid-template-columns: 1fr !important;
            }

            table td, table th { font-size: 0.8rem; padding: 0.5rem 0.6rem; }
            .card { padding: 1rem; }
            .btn-group { flex-wrap: wrap; gap: 0.4rem; }
            .btn-group button, .btn-group a { flex: 1 1 auto; }

            .calendar-grid { gap: 0.25rem; }
        }

        /* ---- 480px (mobile portrait) ---- */
        @media (max-width: 480px) {
            main { padding: 0.75rem; }
            .stats-grid, .metrics-grid, .kpi-grid, .summary-strip {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }
            .page-header h1 { font-size: 1.2rem; }
            .card { padding: 0.85rem; border-radius: 12px; }
            .stat-card h2, .kpi-card h2, .stat-value { font-size: 1.6rem; }
            button, .btn { font-size: 0.85rem; padding: 10px 14px; }
            .filter-tabs button { font-size: 0.75rem; padding: 6px 10px; }
            .table-wrap table { min-width: 480px; }
            table td, table th { font-size: 0.75rem; padding: 0.4rem 0.5rem; }
            .badge, .status-badge { font-size: 0.7rem; padding: 2px 7px; }
            aside { width: 240px; }
        }

        /* ---- 360px (very small phones) ---- */
        @media (max-width: 360px) {
            main { padding: 0.5rem; }
            .page-header h1 { font-size: 1.1rem; }
            aside { width: 220px; }
            .stats-grid, .metrics-grid, .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
    <aside id="sidebar">
        <div class="brand"><span><i class="fa-solid fa-layer-group"></i> VenuePro</span><button class="close-sidebar" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></button></div>
        <nav>
            <a href="index.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
            <a href="bookings.html" class="nav-link"><i class="fa-solid fa-calendar-days"></i> Bookings</a>
            <a href="calendar.html" class="nav-link active"><i class="fa-solid fa-calendar-alt"></i> Calendar</a>
            <a href="customers.html" class="nav-link"><i class="fa-solid fa-users"></i> Customers</a>
            <a href="accounts.html" class="nav-link"><i class="fa-solid fa-file-invoice-dollar"></i> Accounts</a>
            <a href="audit-log.html" class="nav-link"><i class="fa-solid fa-clock-rotate-left"></i> Audit Log</a>
            <a href="enquiry-form.html" class="nav-link" target="_blank"><i class="fa-solid fa-file-pen"></i> New Booking</a>
            <a href="manual-booking.html" class="nav-link"><i class="fa-solid fa-person-walking-arrow-right"></i> Walk-In Booking</a>
            <a href="users.html" class="nav-link"><i class="fa-solid fa-user-shield"></i> Users</a>
            <a href="#" onclick="logout()" class="nav-link" style="margin-top:auto;color:#ef4444;border-top:1px solid rgba(255,255,255,0.05)"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </nav>
    </aside>
    <main>
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
            <div style="display:flex;align-items:center">
                <button class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
                <h1 style="font-size:1.8rem;font-weight:700">Event Calendar</h1>
            </div>
            <a href="calendar.html" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);color:var(--primary);padding:8px 14px;border-radius:8px;text-decoration:none;font-size:0.85rem;font-weight:600">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> New tab
            </a>
            <button onclick="openBlockModal()" style="display:flex;align-items:center;gap:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:8px 14px;border-radius:8px;font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;">
                <i class="fa-solid fa-ban"></i> Blocked Dates
            </button>
        </header>
        <div class="cal-filter-bar">
            <select id="roomFilter" class="cal-filter-select" onchange="applyFilters()">
                <option value="">All Rooms</option>
            </select>
            <select id="statusFilter" class="cal-filter-select" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="paid">Fully Paid</option>
                <option value="balance">Balance Due</option>
                <option value="past">Past Events</option>
            </select>
            <button onclick="clearFilters()" style="background:rgba(148,163,184,0.1);border:1px solid var(--border);color:var(--text-muted);padding:9px 14px;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;font-family:inherit;transition:0.2s" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--text-muted)'">
                <i class="fa-solid fa-xmark"></i> Clear
            </button>
            <div class="cal-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div> Fully Paid</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> Balance Due</div>
                <div class="legend-item"><div class="legend-dot" style="background:#475569"></div> Past Event</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ef4444;opacity:0.5"></div> Closed</div>
            </div>
        </div>
        <div id="calendar"></div>
    </main>

    <!-- BLOCKED DATES MODAL -->
    <div id="blockModal" class="bd-modal-overlay" onclick="if(event.target.id==='blockModal')closeBlockModal()">
        <div class="bd-modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h3 style="font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-ban" style="color:#ef4444"></i> Manage Blocked Dates</h3>
                <button onclick="closeBlockModal()" style="background:none;border:none;color:var(--text-muted);font-size:1.4rem;cursor:pointer;min-height:unset;">&times;</button>
            </div>
            <div style="background:rgba(0,0,0,0.15);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1.25rem;">
                <div style="font-size:0.78rem;font-weight:600;color:var(--text-muted);margin-bottom:0.75rem;text-transform:uppercase;letter-spacing:0.05em;">Add New Block</div>
                <div style="display:flex;flex-direction:column;gap:0.75rem;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                        <div>
                            <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">Type</label>
                            <select id="bd-type" class="bd-select" onchange="toggleBlockFields()">
                                <option value="recurring">Recurring weekday</option>
                                <option value="oneoff">Specific date</option>
                                <option value="range">Date range</option>
                            </select>
                        </div>
                        <div id="bd-field-dow">
                            <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">Day</label>
                            <select id="bd-dow" class="bd-select">
                                <option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option>
                                <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option>
                            </select>
                        </div>
                        <div id="bd-field-date" style="display:none;">
                            <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">Date</label>
                            <input type="date" id="bd-date" class="bd-input">
                        </div>
                    </div>
                    <div id="bd-field-range" style="display:none;grid-template-columns:1fr 1fr;gap:0.75rem;">
                        <div>
                            <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">From</label>
                            <input type="date" id="bd-from" class="bd-input">
                        </div>
                        <div>
                            <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">To</label>
                            <input type="date" id="bd-to" class="bd-input">
                        </div>
                    </div>
                    <div>
                        <label style="font-size:0.78rem;color:var(--text-muted);display:block;margin-bottom:4px;">Label <span style="opacity:0.65">(shown on calendar)</span></label>
                        <input type="text" id="bd-label" class="bd-input" placeholder="e.g. Closed, Bank Holiday, Private Event...">
                    </div>
                    <button onclick="addBlockedDate()" class="bd-btn-add" id="bd-save-btn"><i class="fa-solid fa-plus"></i> Add Blocked Date</button>
                </div>
            </div>
            <div style="font-size:0.78rem;font-weight:600;color:var(--text-muted);margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:0.05em;">Current Blocks</div>
            <div id="bd-list-wrap"><div class="bd-empty">No dates blocked yet</div></div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay" onclick="if(event.target.id==='eventModal')closeModal()">
        <div class="modal-card">
            <div class="modal-top">
                <div class="modal-title" id="e-title">&#x2014;</div>
                <button class="modal-close-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-user" style="margin-right:6px;opacity:0.6"></i>Customer</span><span class="modal-val" id="e-customer">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-envelope" style="margin-right:6px;opacity:0.6"></i>Email</span><span class="modal-val" id="e-email" style="font-size:0.82rem">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-phone" style="margin-right:6px;opacity:0.6"></i>Phone</span><span class="modal-val" id="e-phone">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-layer-group" style="margin-right:6px;opacity:0.6"></i>Room</span><span class="modal-val" id="e-room">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-clock" style="margin-right:6px;opacity:0.6"></i>Time</span><span class="modal-val" id="e-time">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-users" style="margin-right:6px;opacity:0.6"></i>Guests</span><span class="modal-val" id="e-guests">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-sterling-sign" style="margin-right:6px;opacity:0.6"></i>Total</span><span class="modal-val" id="e-total">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label"><i class="fa-solid fa-coins" style="margin-right:6px;opacity:0.6"></i>Balance Due</span><span class="modal-val" id="e-balance">&#x2014;</span></div>
            <div class="modal-row"><span class="modal-label">Status</span><span id="e-status-badge">&#x2014;</span></div>
            <div class="pay-timeline">
                <div class="tl-step"><div class="tl-dot done" id="tl-deposit"><i class="fa-solid fa-check"></i></div><div class="tl-label">Deposit</div></div>
                <div class="tl-line" id="tl-line1"></div>
                <div class="tl-step"><div class="tl-dot pending" id="tl-balance"><i class="fa-solid fa-circle"></i></div><div class="tl-label">Balance</div></div>
                <div class="tl-line" id="tl-line2"></div>
                <div class="tl-step"><div class="tl-dot pending" id="tl-settled"><i class="fa-solid fa-circle-check"></i></div><div class="tl-label">Settled</div></div>
            </div>
            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>
    <script>
        const API_URL='https://n8n.srv1090894.hstgr.cloud/webhook/all-bookings';
        const BLOCKED_API='https://n8n.srv1090894.hstgr.cloud/webhook/blocked-dates';
        const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const fmt=n=>new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(parseFloat(n)||0);
        function getAuthHeaders(){return{'Authorization':'Bearer '+(localStorage.getItem('vp_token')||'')};}

        let allBlockedRules=[], blockedBgEvents=[];

        function generateBlockedBgEvents(rules){
            const events=[];
            const rs=new Date(); rs.setMonth(rs.getMonth()-1);
            const re=new Date(); re.setFullYear(re.getFullYear()+2);
            for(const b of rules){
                const label=b.label||'Closed';
                const ep={blockId:b.id,blockType:b.block_type,label};
                if(b.block_type==='recurring'&&b.day_of_week!==null&&b.day_of_week!==undefined){
                    const d=new Date(rs);
                    while(d.getDay()!==parseInt(b.day_of_week))d.setDate(d.getDate()+1);
                    while(d<=re){events.push({title:label,start:d.toISOString().split('T')[0],display:'background',backgroundColor:'#ef4444',extendedProps:{...ep,dayName:DAY_NAMES[b.day_of_week]}});d.setDate(d.getDate()+7);}
                }else if(b.block_type==='oneoff'&&b.block_date){
                    events.push({title:label,start:b.block_date.split('T')[0],display:'background',backgroundColor:'#ef4444',extendedProps:ep});
                }else if(b.block_type==='range'&&b.date_from&&b.date_to){
                    const d=new Date(b.date_from.split('T')[0]+'T00:00:00');
                    const to=new Date(b.date_to.split('T')[0]+'T00:00:00');
                    while(d<=to){events.push({title:label,start:d.toISOString().split('T')[0],display:'background',backgroundColor:'#ef4444',extendedProps:ep});d.setDate(d.getDate()+1);}
                }
            }
            return events;
        }

        async function loadBlockedDates(){
            try{
                const res=await fetch(BLOCKED_API);
                const json=await res.json();
                allBlockedRules=json.data||[];
                blockedBgEvents=generateBlockedBgEvents(allBlockedRules);
            }catch(e){console.warn('Blocked dates load failed:',e);}
        }

        function openBlockModal(){renderBlockedList();document.getElementById('blockModal').classList.add('open');}
        function closeBlockModal(){document.getElementById('blockModal').classList.remove('open');}

        function toggleBlockFields(){
            const t=document.getElementById('bd-type').value;
            document.getElementById('bd-field-dow').style.display  =t==='recurring'?'':'none';
            document.getElementById('bd-field-date').style.display =t==='oneoff'?'':'none';
            const rf=document.getElementById('bd-field-range');
            rf.style.display=t==='range'?'grid':'none';
        }

        function renderBlockedList(){
            const wrap=document.getElementById('bd-list-wrap');
            if(!allBlockedRules.length){wrap.innerHTML='<div class="bd-empty">No dates blocked yet</div>';return;}
            wrap.innerHTML=allBlockedRules.map(b=>{
                let detail='';
                if(b.block_type==='recurring')detail=`Every ${DAY_NAMES[b.day_of_week]}`;
                else if(b.block_type==='oneoff')detail=`One-off: ${new Date(b.block_date+'T00:00:00').toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
                else if(b.block_type==='range')detail=`Range: ${new Date(b.date_from+'T00:00:00').toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})} – ${new Date(b.date_to+'T00:00:00').toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
                return `<div class="bd-item"><div class="bd-item-info"><div class="bd-item-label">${b.label||'Closed'}</div><div class="bd-item-detail">${detail}</div></div><button class="bd-item-del" onclick="deleteBlockedDate(${b.id})" title="Remove"><i class="fa-solid fa-trash-can"></i></button></div>`;
            }).join('');
        }

        async function addBlockedDate(){
            const type=document.getElementById('bd-type').value;
            const label=document.getElementById('bd-label').value.trim();
            const btn=document.getElementById('bd-save-btn');
            const payload={block_type:type,label:label||'Closed',created_by:'staff'};
            if(type==='recurring'){payload.day_of_week=parseInt(document.getElementById('bd-dow').value);}
            else if(type==='oneoff'){const d=document.getElementById('bd-date').value;if(!d){alert('Please select a date');return;}payload.block_date=d;}
            else if(type==='range'){const f=document.getElementById('bd-from').value,t=document.getElementById('bd-to').value;if(!f||!t){alert('Please select both dates');return;}if(f>t){alert('From date must be before To date');return;}payload.date_from=f;payload.date_to=t;}
            btn.disabled=true;btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';
            try{
                const res=await fetch(BLOCKED_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
                const json=await res.json();
                if(json.success){
                    allBlockedRules.push(json.data);blockedBgEvents=generateBlockedBgEvents(allBlockedRules);
                    if(calendarInstance){calendarInstance.removeAllEvents();calendarInstance.addEventSource([...allEvents,...blockedBgEvents]);}
                    renderBlockedList();document.getElementById('bd-label').value='';
                }
            }catch(e){alert('Failed to save. Please try again.');}
            btn.disabled=false;btn.innerHTML='<i class="fa-solid fa-plus"></i> Add Blocked Date';
        }

        async function deleteBlockedDate(id){
            if(!confirm('Remove this block?'))return;
            try{
                const res=await fetch(BLOCKED_API,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
                const json=await res.json();
                if(json.success){
                    allBlockedRules=allBlockedRules.filter(b=>b.id!==id);blockedBgEvents=generateBlockedBgEvents(allBlockedRules);
                    if(calendarInstance){calendarInstance.removeAllEvents();calendarInstance.addEventSource([...allEvents,...blockedBgEvents]);}
                    renderBlockedList();
                }
            }catch(e){alert('Failed to delete. Please try again.');}
        }
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active');
        }
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }
        function logout(){if(confirm("Log out?")){localStorage.removeItem('vp_token');window.location.href='login.html';}}
        function closeModal(){document.getElementById('eventModal').classList.remove('open');}
        let allEvents=[],calendarInstance=null;
        function clearFilters(){document.getElementById('roomFilter').value='';document.getElementById('statusFilter').value='';applyFilters();}
        function applyFilters(){
            const roomVal=document.getElementById('roomFilter').value;
            const statusVal=document.getElementById('statusFilter').value;
            const now=new Date();now.setHours(0,0,0,0);
            let filtered=allEvents;
            if(roomVal)filtered=filtered.filter(e=>e.extendedProps.room_name===roomVal);
            if(statusVal)filtered=filtered.filter(e=>{
                const isPast=new Date(e.extendedProps.booking_date)<now;
                const hasBal=parseFloat(e.extendedProps.balance_due||0)>0;
                if(statusVal==='paid')return !hasBal&&!isPast;
                if(statusVal==='balance')return hasBal&&!isPast;
                if(statusVal==='past')return isPast;
                return true;
            });
            if(calendarInstance){calendarInstance.removeAllEvents();calendarInstance.addEventSource([...filtered,...blockedBgEvents]);}}
        }
        document.addEventListener('DOMContentLoaded',async function(){
            const calEl=document.getElementById('calendar');
            try{
                await loadBlockedDates();
                const res=await fetch(API_URL,{headers:getAuthHeaders()});
                const json=await res.json();
                const raw=json.data||(Array.isArray(json)?json:[]);
                const now=new Date();now.setHours(0,0,0,0);
                const rooms=[...new Set(raw.map(e=>e.room_name).filter(Boolean))].sort();
                const roomSel=document.getElementById('roomFilter');
                rooms.forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;roomSel.appendChild(o);});
                allEvents=raw.filter(e=>e.status!=='cancelled'&&e.booking_date).map(e=>{
                    const bDate=new Date(e.booking_date.split('T')[0]);
                    const balance=parseFloat(e.balance_due||0);
                    const isPast=bDate<now;
                    const startT=(e.start_time||'09:00').slice(0,5);
                    const endT=(e.end_time||'10:00').slice(0,5);
                    const dateStr=e.booking_date.split('T')[0];
                    const color=isPast?'#475569':balance>0?'#f59e0b':'#10b981';
                    return{
                        title:e.customer_name||'Guest',
                        start:`${dateStr}T${startT}:00`,
                        end:`${dateStr}T${endT}:00`,
                        backgroundColor:color,borderColor:color,
                        extendedProps:{customer_name:e.customer_name||'Guest',customer_email:e.customer_email||e.email||'',customer_phone:e.customer_phone||e.phone||'',room_name:e.room_name||'Unknown',booking_date:e.booking_date,time:`${startT} \u2013 ${endT}`,total_amount:e.total_amount,balance_due:e.balance_due,guest_count:e.guest_count,isPast}
                    };
                });
                calendarInstance=new FullCalendar.Calendar(calEl,{
                    initialView:'dayGridMonth',
                    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek'},
                    events:[...allEvents,...blockedBgEvents],height:'auto',
                    eventContent:function(arg){
                        const p=arg.event.extendedProps;
                        const room=p.room_name?`<span style="opacity:0.75;font-size:0.74rem"> \u00b7 ${p.room_name}</span>`:'';
                        return{html:`<div style="padding:2px 5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><strong>${arg.event.title}</strong>${room}</div>`};
                    },
                    eventClick:function(info){
                        const p=info.event.extendedProps;
                        const balance=parseFloat(p.balance_due||0);
                        document.getElementById('e-title').innerText=info.event.title+' \u2014 '+(p.room_name||'Unknown');
                        document.getElementById('e-customer').innerText=p.customer_name||'N/A';
                        document.getElementById('e-email').innerText=p.customer_email||'N/A';
                        document.getElementById('e-phone').innerText=p.customer_phone||'N/A';
                        document.getElementById('e-room').innerText=p.room_name||'N/A';
                        document.getElementById('e-time').innerText=p.time;
                        document.getElementById('e-guests').innerText=p.guest_count||'\u2014';
                        document.getElementById('e-total').innerText=p.total_amount!=null?fmt(p.total_amount):'\u2014';
                        document.getElementById('e-balance').innerText=fmt(balance);
                        let badge;
                        if(p.isPast)badge='<span class="status-pill pill-past">Completed</span>';
                        else if(balance>0)badge=`<span class="status-pill pill-balance">\u00a3${balance.toFixed(2)} Due</span>`;
                        else badge='<span class="status-pill pill-paid">Fully Paid</span>';
                        document.getElementById('e-status-badge').innerHTML=badge;
                        const tD=document.getElementById('tl-deposit'),tB=document.getElementById('tl-balance'),tS=document.getElementById('tl-settled');
                        const l1=document.getElementById('tl-line1'),l2=document.getElementById('tl-line2');
                        tD.className='tl-dot done';tD.innerHTML='<i class="fa-solid fa-check"></i>';l1.className='tl-line done';
                        if(balance<=0){tB.className='tl-dot done';tB.innerHTML='<i class="fa-solid fa-check"></i>';l2.className='tl-line done';tS.className='tl-dot done';tS.innerHTML='<i class="fa-solid fa-circle-check"></i>';}
                        else{tB.className='tl-dot active';tB.innerHTML='<i class="fa-solid fa-coins"></i>';l2.className='tl-line';tS.className='tl-dot pending';tS.innerHTML='<i class="fa-solid fa-circle"></i>';}
                        document.getElementById('eventModal').classList.add('open');
                    }
                });
                calendarInstance.render();
            }catch(e){console.error('Calendar error:',e);}
        });
    
        // ── THEME PERSISTENCE ──
        (function(){ var t=localStorage.getItem('vp_theme'); if(t==='light') document.body.classList.add('light-mode'); })();
        function toggleTheme(){
            var isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('vp_theme', isLight ? 'light' : 'dark');
            var btn = document.getElementById('theme-btn');
            if(btn) btn.innerHTML = isLight ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        }
        // Set correct icon on load
        document.addEventListener('DOMContentLoaded', function(){
            var btn = document.getElementById('theme-btn');
            if(btn) {
                var isLight = document.body.classList.contains('light-mode');
                btn.innerHTML = isLight ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            }
        });
</script>
</body>
</html>