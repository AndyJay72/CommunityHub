<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financials | VenuePro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (!localStorage.getItem('vp_token')) { window.location.href = 'login.html'; }
    </script>
    <style>
        :root { --bg-dark: #0f172a; --bg-card: rgba(30, 41, 59, 0.7); --border: rgba(148, 163, 184, 0.1); --primary: #6366f1; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #0ea5e9; --text-main: #f8fafc; --text-muted: #94a3b8; --sidebar-width: 260px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--bg-dark); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-dark); background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%); color: var(--text-main); min-height: 100vh; display: flex; overflow-x: hidden; }
        aside { width: var(--sidebar-width); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-right: 1px solid var(--border); padding: 2rem; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s ease; }
        .brand { font-size: 1.5rem; font-weight: 700; color: white; display: flex; align-items: center; justify-content: space-between; margin-bottom: 3rem; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .close-sidebar { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        main { margin-left: var(--sidebar-width); flex: 1; padding: 2rem; max-width: 1600px; width: 100%; transition: margin-left 0.3s ease; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .menu-toggle { display: none; background: var(--bg-card); border: 1px solid var(--border); color: white; width: 40px; height: 40px; border-radius: 8px; align-items: center; justify-content: center; cursor: pointer; margin-right: 15px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--bg-card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--color); }
        .kpi-title { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
        .kpi-val { font-size: 2.2rem; font-weight: 700; color: white; }
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .chart-container { background: var(--bg-card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); position: relative; height: 350px; display: flex; flex-direction: column; }
        .chart-container h3 { margin-bottom: 1rem; font-size: 1.1rem; color: white; }
        .rooms-chart-container { background: var(--bg-card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 2rem; }
        .rooms-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
        .rooms-chart-header h3 { font-size: 1.1rem; color: white; }
        .month-nav { display: flex; align-items: center; gap: 10px; }
        .month-nav-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 30px; height: 30px; border-radius: 6px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; line-height: 1; }
        .month-nav-btn:hover { color: white; border-color: white; }
        .month-label { font-size: 0.9rem; font-weight: 600; color: var(--text-main); min-width: 90px; text-align: center; }
        .rooms-chart-canvas-wrap { position: relative; width: 100%; }
        /* TRANSACTION TABLE */
        .transaction-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; }
        .trans-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        .trans-header h3 { font-size: 1.1rem; color: white; }
        .trans-hint { font-size: 0.8rem; color: var(--text-muted); }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; max-height: 480px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { text-align: left; color: var(--text-muted); padding: 12px 14px; border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 0.75rem; position: sticky; top: 0; background: #131b2e; white-space: nowrap; }
        td { padding: 13px 14px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.9rem; vertical-align: middle; }
        tr.clickable:hover td { background: rgba(99,102,241,0.06); cursor: pointer; }
        .type-badge { display: inline-block; font-size: 0.72rem; font-weight: 700; padding: 2px 8px; border-radius: 12px; text-transform: uppercase; }
        .type-deposit  { background: rgba(99,102,241,0.15); color: var(--primary); }
        .type-full     { background: rgba(16,185,129,0.15); color: var(--success); }
        .type-partial  { background: rgba(245,158,11,0.15); color: var(--warning); }
        .type-balance  { background: rgba(16,185,129,0.15); color: var(--success); }
        .ref-mono { font-family: monospace; font-size: 0.82rem; color: var(--primary); }
        .linked-ref { font-family: monospace; font-size: 0.78rem; color: var(--text-muted); }
        /* INVOICE MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 300; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .invoice-modal { background: #1e293b; border: 1px solid var(--border); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .invoice-header { background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(30,41,59,0)); padding: 1.75rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; }
        .invoice-title { font-size: 1.4rem; font-weight: 700; }
        .invoice-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .invoice-ref-badge { font-family: monospace; font-size: 0.9rem; background: rgba(99,102,241,0.15); color: var(--primary); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 6px 14px; text-align: right; }
        .invoice-body { padding: 1.75rem 2rem; }
        .invoice-section { margin-bottom: 1.5rem; }
        .invoice-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .invoice-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.9rem; }
        .invoice-row .ilabel { color: var(--text-muted); }
        .invoice-row .ivalue { color: var(--text-main); font-weight: 500; }
        .invoice-row .ivalue.mono { font-family: monospace; font-size: 0.85rem; color: var(--primary); }
        .invoice-total-row { display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; border-top: 2px solid var(--border); }
        .invoice-total-row .ilabel { font-weight: 700; }
        .invoice-total-row .ivalue { font-weight: 700; font-size: 1.15rem; }
        .invoice-footer { padding: 1.25rem 2rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 900px)  { .charts-grid { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px)  {
            aside { transform: translateX(-100%); } aside.active { transform: translateX(0); }
            main { margin-left: 0; padding: 1rem; } .menu-toggle { display: flex; } .close-sidebar { display: block; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <!-- INVOICE MODAL -->
    <div class="modal-overlay" id="invoiceModal" onclick="closeModal(event)">
        <div class="invoice-modal" onclick="event.stopPropagation()">
            <div class="invoice-header">
                <div>
                    <div class="invoice-title"><i class="fa-solid fa-file-invoice-dollar" style="color:var(--primary); margin-right:8px;"></i>Payment Receipt</div>
                    <div class="invoice-subtitle" id="invSubtitle">VenuePro Transaction</div>
                </div>
                <div>
                    <div class="invoice-ref-badge" id="invRef">—</div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-align:right; margin-top:4px;" id="invDate">—</div>
                </div>
            </div>
            <div class="invoice-body">
                <div class="invoice-section">
                    <div class="invoice-section-title">Customer</div>
                    <div class="invoice-row"><span class="ilabel">Name</span><span class="ivalue" id="invCustomer">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Email</span><span class="ivalue" id="invEmail">—</span></div>
                </div>
                <div class="invoice-section">
                    <div class="invoice-section-title">Booking Details</div>
                    <div class="invoice-row"><span class="ilabel">Room</span><span class="ivalue" id="invRoom">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Booking Date</span><span class="ivalue" id="invBookingDate">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Time</span><span class="ivalue" id="invTime">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Total Booking Value</span><span class="ivalue" id="invTotal">—</span></div>
                </div>
                <div class="invoice-section">
                    <div class="invoice-section-title">This Transaction</div>
                    <div class="invoice-row"><span class="ilabel">Payment Type</span><span class="ivalue" id="invType">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Payment Method</span><span class="ivalue" id="invMethod">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Reference</span><span class="ivalue mono" id="invRefDetail">—</span></div>
                    <div class="invoice-row" id="invOrigRefRow"><span class="ilabel">Linked to Deposit</span><span class="ivalue mono" id="invOrigRef">—</span></div>
                    <div class="invoice-row"><span class="ilabel">Status</span><span class="ivalue" id="invStatus">—</span></div>
                </div>
                <div class="invoice-total-row">
                    <span class="ilabel">Amount Paid</span>
                    <span class="ivalue" id="invAmount" style="color:var(--success);">—</span>
                </div>
            </div>
            <div class="invoice-footer">
                <button onclick="closeModalDirect()" style="padding:10px 20px; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-muted); border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                    <i class="fa-solid fa-xmark"></i> Close
                </button>
                <button onclick="printInvoice()" style="padding:10px 20px; background:rgba(99,102,241,0.15); border:1px solid rgba(99,102,241,0.3); color:var(--primary); border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                    <i class="fa-solid fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand"><span><i class="fa-solid fa-layer-group"></i> VenuePro</span><button class="close-sidebar" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></button></div>
        <nav>
            <a href="index.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
            <a href="bookings.html" class="nav-link"><i class="fa-solid fa-calendar-days"></i> Bookings</a>
            <a href="customers.html" class="nav-link"><i class="fa-solid fa-users"></i> Customers</a>
            <a href="accounts.html" class="nav-link active"><i class="fa-solid fa-file-invoice-dollar"></i> Accounts</a>
            <a href="venuepro_booking.html" class="nav-link"><i class="fa-solid fa-building"></i> Event Booking</a>
            <a href="enquiry-form.html" class="nav-link" target="_blank"><i class="fa-solid fa-file-pen"></i> New Booking</a>
            <a href="manual-booking.html" class="nav-link"><i class="fa-solid fa-person-walking-arrow-right"></i> Walk-In Booking</a>
            <a href="final-payment.html" class="nav-link"><i class="fa-solid fa-check-double"></i> Final Payment</a>
            <a href="calendar.html" class="nav-link"><i class="fa-solid fa-calendar-alt"></i> Calendar</a>
            <a href="audit-log.html" class="nav-link"><i class="fa-solid fa-clock-rotate-left"></i> Audit Log</a>
            <a href="users.html" class="nav-link"><i class="fa-solid fa-user-shield"></i> Users</a>
            <a href="#" onclick="logout()" class="nav-link" style="margin-top: auto; color: #ef4444; border-top: 1px solid rgba(255,255,255,0.05);">
                <i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </nav>
    </aside>

    <main>
        <header>
            <div style="display:flex; align-items:center;">
                <button class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
                <h1 style="font-size: 1.8rem; font-weight: 700;">Financial Overview</h1>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card" style="--color: var(--success);">
                <div class="kpi-title">Net Revenue (All Time)</div>
                <div class="kpi-val" id="total-revenue">£0.00</div>
            </div>
            <div class="kpi-card" style="--color: var(--primary);">
                <div class="kpi-title">Deposits Collected</div>
                <div class="kpi-val" id="total-deposits">£0.00</div>
            </div>
            <div class="kpi-card" style="--color: var(--warning);">
                <div class="kpi-title">Outstanding Balance</div>
                <div class="kpi-val" id="total-outstanding">£0.00</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3><i class="fa-solid fa-chart-bar" style="color:var(--primary)"></i> Revenue Trends</h3>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-container">
                <h3><i class="fa-solid fa-wallet" style="color:var(--success)"></i> Payment Status</h3>
                <canvas id="doughnutChart"></canvas>
            </div>
            <div class="chart-container">
                <h3><i class="fa-solid fa-heart-pulse" style="color:var(--info)"></i> Booking Health</h3>
                <canvas id="healthChart"></canvas>
            </div>
        </div>

        <div class="rooms-chart-container">
            <div class="rooms-chart-header">
                <h3><i class="fa-solid fa-door-open" style="color:var(--info)"></i> Most Booked Rooms</h3>
                <div class="month-nav">
                    <button class="month-nav-btn" onclick="changeRoomsMonth(-1)">&#8249;</button>
                    <span class="month-label" id="rooms-month-label">-- ----</span>
                    <button class="month-nav-btn" onclick="changeRoomsMonth(1)">&#8250;</button>
                </div>
            </div>
            <div class="rooms-chart-canvas-wrap" id="rooms-chart-wrap">
                <canvas id="roomsChart" height="160"></canvas>
            </div>
        </div>

        <div class="transaction-container">
            <div class="trans-header">
                <h3><i class="fa-solid fa-list" style="color:var(--text-muted); margin-right:8px;"></i>Recent Transactions</h3>
                <span class="trans-hint"><i class="fa-solid fa-arrow-pointer"></i> Click a row to view invoice</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Linked To</th>
                            <th>Customer</th>
                            <th>Room</th>
                            <th>Event Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="trans-body">
                        <tr><td colspan="9" style="text-align:center; padding:2rem; color:var(--text-muted)">Loading transactions...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        function logout() {
            if(confirm("Are you sure you want to log out?")) {
                localStorage.removeItem('vp_token');
                localStorage.removeItem('vp_user');
                window.location.href = 'login.html';
            }
        }

        const fmt = n => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(n);
        const API_URL          = 'https://n8n.srv1090894.hstgr.cloud/webhook/accounts-data';
        const ALL_BOOKINGS_URL = 'https://n8n.srv1090894.hstgr.cloud/webhook/all-bookings';
        const MONTHS_FULL  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        let roomsChartMonth = new Date().getMonth() + 1;
        let roomsChartYear  = new Date().getFullYear();
        let roomsChartInst  = null;
        let allTransactions = [];

        function getAuthHeaders() {
            return { 'Authorization': 'Bearer ' + (localStorage.getItem('vp_token') || '') };
        }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function typeClass(t, bDue) {
            if (!t) return '';
            t = t.toLowerCase();
            if (t === 'deposit')  return 'type-deposit';
            if (t === 'full')     return 'type-full';
            if (t === 'partial')  return 'type-partial';
            if (t === 'balance') {
                return (parseFloat(bDue) > 0.005) ? 'type-partial' : 'type-full';
            }
            return '';
        }

        function typeLabel(t, bDue) {
            if (!t) return '—';
            t = t.toLowerCase();
            if (t === 'deposit')  return 'Deposit';
            if (t === 'full')     return 'Final Payment';
            if (t === 'partial')  return 'Part Payment';
            if (t === 'balance') {
                return (parseFloat(bDue) > 0.005) ? 'Part Payment' : 'Final Payment';
            }
            return t;
        }

        async function loadAccounts() {
            try {
                const response = await fetch(API_URL, { headers: getAuthHeaders() });
                const json = await response.json();
                const rootData     = json.data || json;
                const metrics      = rootData.metrics      || {};
                const transactions = rootData.transactions || [];
                allTransactions    = transactions;

                const revenue     = parseFloat(metrics.total_revenue) || 0;
                const deposits    = parseFloat(metrics.deposits)      || 0;
                const outstanding = parseFloat(metrics.outstanding)   || 0;

                document.getElementById('total-revenue').innerText     = fmt(revenue);
                document.getElementById('total-deposits').innerText    = fmt(deposits);
                document.getElementById('total-outstanding').innerText = fmt(outstanding);

                Chart.defaults.color       = '#94a3b8';
                Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";

                new Chart(document.getElementById('doughnutChart'), {
                    type: 'doughnut',
                    data: { labels: ['Collected', 'Outstanding'], datasets: [{ data: [revenue, outstanding], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
                });

                const countCompleted = parseInt(metrics.count_completed) || 0;
                const countCancelled = parseInt(metrics.count_cancelled) || 0;
                new Chart(document.getElementById('healthChart'), {
                    type: 'doughnut',
                    data: { labels: ['Completed/Active', 'Cancelled'], datasets: [{ data: [countCompleted, countCancelled], backgroundColor: ['#0ea5e9', '#ef4444'], borderWidth: 0, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
                });

                new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: { labels: ['Deposits', 'Outstanding', 'Net Revenue'], datasets: [{ label: 'Amount (£)', data: [deposits, outstanding, revenue], backgroundColor: ['#6366f1', '#f59e0b', '#10b981'], borderRadius: 6 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });

                renderTransactions(transactions);

            } catch(e) { console.error('loadAccounts:', e); }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('trans-body');
            if (!transactions.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:2rem; color:var(--text-muted)">No recent transactions</td></tr>';
                return;
            }
            tbody.innerHTML = transactions.map((t, i) => {
                const amt    = parseFloat(t.amount);
                const color  = amt < 0 ? 'var(--danger)' : 'var(--success)';
                const pDate  = t.payment_date ? new Date(t.payment_date).toLocaleDateString('en-GB') : '—';
                const bDate  = t.booking_date  ? new Date(t.booking_date).toLocaleDateString('en-GB')  : '—';
                const time   = (t.start_time && t.end_time) ? t.start_time + ' \u2013 ' + t.end_time : '';
                const isLink = t.payment_type && t.payment_type.toLowerCase() !== 'deposit' && t.deposit_reference;
                return '<tr class="clickable" onclick="showInvoice(' + i + ')">' +
                    '<td>' + pDate + '</td>' +
                    '<td><span class="ref-mono">' + (t.reference_number || '—') + '</span></td>' +
                    '<td>' + (isLink ? '<span class="linked-ref">' + t.deposit_reference + '</span>' : '<span style="color:var(--text-muted); font-size:0.8rem;">—</span>') + '</td>' +
                    '<td>' + (t.customer_name || '—') + '</td>' +
                    '<td>' + (t.room_name     || '—') + '</td>' +
                    '<td>' + bDate + (time ? '<br><span style="font-size:0.78rem; color:var(--text-muted);">' + time + '</span>' : '') + '</td>' +
                    '<td><span class="type-badge ' + typeClass(t.payment_type, t.booking_balance_due) + '">' + typeLabel(t.payment_type, t.booking_balance_due) + '</span></td>' +
                    '<td style="font-weight:700; color:' + color + '">' + fmt(amt) + '</td>' +
                    '<td><span style="color:' + color + '; text-transform:uppercase; font-size:0.78rem;">' + (t.status || '—') + '</span></td>' +
                    '</tr>';
            }).join('');
        }

        function showInvoice(idx) {
            const t = allTransactions[idx];
            if (!t) return;

            const pDateFull = t.payment_date ? new Date(t.payment_date).toLocaleString('en-GB') : '—';
            const bDate     = t.booking_date  ? new Date(t.booking_date).toLocaleDateString('en-GB')  : '—';
            const time      = (t.start_time && t.end_time) ? t.start_time + ' \u2013 ' + t.end_time : '—';
            const amt       = parseFloat(t.amount);
            const isDeposit = (t.payment_type || '').toLowerCase() === 'deposit';

            document.getElementById('invSubtitle').innerText     = 'Issued ' + pDateFull;
            document.getElementById('invRef').innerText          = t.reference_number || 'N/A';
            document.getElementById('invDate').innerText         = pDateFull;
            document.getElementById('invCustomer').innerText     = t.customer_name  || '—';
            document.getElementById('invEmail').innerText        = t.customer_email || '—';
            document.getElementById('invRoom').innerText         = t.room_name      || '—';
            document.getElementById('invBookingDate').innerText  = bDate;
            document.getElementById('invTime').innerText         = time;
            document.getElementById('invTotal').innerText        = t.total_amount != null ? fmt(t.total_amount) : '—';
            document.getElementById('invType').innerHTML         = '<span class="type-badge ' + typeClass(t.payment_type, t.booking_balance_due) + '">' + typeLabel(t.payment_type, t.booking_balance_due) + '</span>';
            const _mMap = { cash: 'Cash', card: 'Card', credit_card: 'Credit Card', debit_card: 'Debit Card', bank_transfer: 'Bank Transfer', bacs: 'BACS', cheque: 'Cheque', other: 'Other' };
            const _mKey = (t.payment_method || '').toLowerCase().replace(/[\s-]/g, '_');
            const _mLabel = _mMap[_mKey] || (_mKey ? _mKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '—');
            document.getElementById('invMethod').innerText        = _mLabel;
            document.getElementById('invRefDetail').innerText    = t.reference_number || '—';
            document.getElementById('invStatus').innerText       = (t.status || '—').toUpperCase();
            document.getElementById('invAmount').innerText       = fmt(amt);

            const origRefRow = document.getElementById('invOrigRefRow');
            if (!isDeposit && t.deposit_reference) {
                document.getElementById('invOrigRef').innerText = t.deposit_reference;
                origRefRow.style.display = 'flex';
            } else {
                origRefRow.style.display = 'none';
            }

            document.getElementById('invoiceModal').classList.add('active');
        }

        function closeModal(e) {
            if (e.target === document.getElementById('invoiceModal')) {
                document.getElementById('invoiceModal').classList.remove('active');
            }
        }

        function closeModalDirect() {
            document.getElementById('invoiceModal').classList.remove('active');
        }

        function printInvoice() {
            const modal = document.querySelector('.invoice-modal');
            const w = window.open('', '_blank', 'width=700,height=900');
            w.document.write('<html><head><title>VenuePro Receipt</title><style>body{font-family:sans-serif;color:#1e293b;padding:2rem} table{width:100%;border-collapse:collapse} td{padding:8px 0;border-bottom:1px solid #e2e8f0} .label{color:#64748b} .mono{font-family:monospace;color:#6366f1} h1{margin-bottom:0.5rem} .amt{font-size:1.4rem;font-weight:700;color:#10b981}</style></head><body>' + modal.innerHTML + '</body></html>');
            w.document.close();
            w.print();
        }

        loadAccounts();

        // ---- ROOMS CHART ----
        async function loadRoomsChart() {
            document.getElementById('rooms-month-label').innerText = MONTHS_SHORT[roomsChartMonth - 1] + ' ' + roomsChartYear;
            const wrap = document.getElementById('rooms-chart-wrap');
            try {
                const res  = await fetch(ALL_BOOKINGS_URL, { headers: getAuthHeaders() });
                const json = await res.json();
                const raw  = json.data || (Array.isArray(json) ? json : []);
                const inMonth = raw.filter(b => {
                    if (b.status === 'cancelled') return false;
                    const d = new Date(b.booking_date);
                    return d.getFullYear() === roomsChartYear && (d.getMonth() + 1) === roomsChartMonth;
                });
                const counts = {};
                inMonth.forEach(b => { const name = b.room_name || 'Unknown'; counts[name] = (counts[name] || 0) + 1; });
                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                const labels = sorted.map(e => e[0]);
                const values = sorted.map(e => e[1]);
                const PALETTE = ['#6366f1','#10b981','#f59e0b','#0ea5e9','#ef4444','#a78bfa','#34d399','#fbbf24'];
                const canvasH = Math.max(160, labels.length * 52);
                wrap.innerHTML = '<canvas id="roomsChart" height="' + canvasH + '"></canvas>';
                if (!labels.length) {
                    wrap.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);"><i class="fa-solid fa-calendar-xmark"></i> No bookings for ' + MONTHS_FULL[roomsChartMonth-1] + ' ' + roomsChartYear + '</div>';
                    return;
                }
                if (roomsChartInst) roomsChartInst.destroy();
                roomsChartInst = new Chart(document.getElementById('roomsChart'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Bookings', data: values, backgroundColor: labels.map((_,i) => PALETTE[i % PALETTE.length]), borderRadius: 6, borderSkipped: false }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ' ' + ctx.raw + ' booking' + (ctx.raw === 1 ? '' : 's') } } },
                        scales: { x: { grid: { color: 'rgba(148,163,184,0.08)' }, ticks: { stepSize: 1, precision: 0 }, beginAtZero: true }, y: { grid: { display: false }, ticks: { color: '#f8fafc', font: { size: 13, weight: '600' } } } }
                    }
                });
            } catch(e) {
                wrap.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);">Could not load room data</div>';
            }
        }

        function changeRoomsMonth(delta) {
            roomsChartMonth += delta;
            if (roomsChartMonth > 12) { roomsChartMonth = 1;  roomsChartYear++; }
            if (roomsChartMonth < 1)  { roomsChartMonth = 12; roomsChartYear--; }
            loadRoomsChart();
        }

        loadRoomsChart();
    </script>
</body>
</html>