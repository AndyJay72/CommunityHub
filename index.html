<script>
        // === CONFIGURATION ===
        const DASHBOARD_WEBHOOK_URL = 'https://n8n.srv1090894.hstgr.cloud/webhook/staff-dashboard';
        const UPDATE_STATUS_URL = 'https://n8n.srv1090894.hstgr.cloud:5678/webhook/update-status';
        const STAFF_NAME = "Manager";

        // === UTILITIES ===
        const formatCurrency = (num) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(num);
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // === MAIN LOGIC ===
        async function loadDashboard() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('fa-spin');

            try {
                const response = await fetch(DASHBOARD_WEBHOOK_URL);
                if (!response.ok) throw new Error(`Request failed: ${response.status}`);

                const json = await response.json();
                
                // ROBUST FIX: Handle nesting
                const data = json.data || json; 
                
                // 1. Populate Metrics
                const metrics = data.metrics || {};
                document.getElementById('val-revenue').innerText = formatCurrency(metrics.total_revenue_month || 0);
                document.getElementById('val-pending').innerText = metrics.pending_requests || 0;
                document.getElementById('val-contacted').innerText = metrics.contacted_today || 0;

                // 2. Populate Requests Table
                const reqBody = document.getElementById('table-requests');
                const requests = data.recent_customers || [];
                
                if (requests.length === 0) {
                    reqBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding: 2rem;">No pending requests</td></tr>`;
                } else {
                    reqBody.innerHTML = requests.map(c => `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${c.full_name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${new Date(c.event_date).toLocaleDateString()}</div>
                            </td>
                            <td>${c.event_type}</td>
                            <td>${c.guests_count}</td>
                            <td><span class="status-badge ${c.status === 'pending' ? 'pending' : 'contacted'}">${c.status}</span></td>
                            <td style="text-align: right;">
                                <button id="btn-${c.id}" class="btn-action" 
                                    style="margin-left: auto;"
                                    onclick="markContacted('${c.id}', '${c.full_name.replace(/'/g, "\\'")}')"
                                    ${c.status !== 'pending' ? 'disabled' : ''}>
                                    ${c.status === 'pending' ? '<i class="fa-solid fa-check"></i> Accept' : '<i class="fa-solid fa-check-double"></i> Done'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                // 3. Populate Bookings Table
                const bookBody = document.getElementById('table-bookings');
                const bookings = data.upcoming_bookings || [];

                if (bookings.length === 0) {
                    bookBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--text-muted); padding: 2rem;">No upcoming events</td></tr>`;
                } else {
                    bookBody.innerHTML = bookings.map(b => `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${new Date(b.booking_date).toLocaleDateString('en-GB', {day: 'numeric', month: 'short'})}</div>
                            </td>
                            <td>${b.room_name}</td>
                            <td><span class="status-badge ${parseFloat(b.balance_due) > 0 ? 'balance' : 'paid'}">
                                ${parseFloat(b.balance_due) > 0 ? formatCurrency(b.balance_due) + ' Due' : 'Paid'}
                            </span></td>
                        </tr>
                    `).join('');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast("Connection Error", "error");
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        // Action Logic
        async function markContacted(id, name) {
            const btn = document.getElementById(`btn-${id}`);
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await fetch(UPDATE_STATUS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, staff_name: STAFF_NAME })
                });

                if (response.ok) {
                    showToast(`${name} marked as contacted`);
                    setTimeout(loadDashboard, 1000); 
                } else { throw new Error("Update failed"); }
            } catch (error) {
                showToast("Failed to update", "error");
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        loadDashboard();
        setInterval(loadDashboard, 60000);
    </script>
